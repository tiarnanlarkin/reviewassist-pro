<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing & Subscription - ReviewAssist Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">ReviewAssist Pro</h1>
                    <span class="ml-2 text-sm text-gray-500">Billing & Subscription</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='/'" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </button>
                    <div id="userInfo" class="hidden">
                        <span id="userName" class="text-sm text-gray-700"></span>
                        <button onclick="logout()" class="ml-4 text-sm text-red-600 hover:text-red-800">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Subscription Status Card -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Current Subscription</h2>
            </div>
            <div class="p-6">
                <div id="subscriptionStatus" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 id="planName" class="text-xl font-semibold text-gray-900"></h3>
                            <p id="planStatus" class="text-sm text-gray-600"></p>
                        </div>
                        <div class="text-right">
                            <p id="billingCycle" class="text-sm text-gray-600"></p>
                            <p id="nextBilling" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                    
                    <div id="trialInfo" class="hidden bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
                        <div class="flex">
                            <i class="fas fa-info-circle text-blue-400 mt-0.5 mr-3"></i>
                            <div>
                                <h4 class="text-sm font-medium text-blue-800">Free Trial Active</h4>
                                <p id="trialEnd" class="text-sm text-blue-700 mt-1"></p>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button id="upgradeBtn" onclick="showUpgradeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            <i class="fas fa-arrow-up mr-2"></i>Upgrade Plan
                        </button>
                        <button onclick="openBillingPortal()" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                            <i class="fas fa-cog mr-2"></i>Manage Billing
                        </button>
                        <button id="cancelBtn" onclick="showCancelModal()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                            <i class="fas fa-times mr-2"></i>Cancel Subscription
                        </button>
                    </div>
                </div>

                <div id="noSubscription" class="hidden text-center py-8">
                    <i class="fas fa-credit-card text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Active Subscription</h3>
                    <p class="text-gray-600 mb-4">Choose a plan to get started with ReviewAssist Pro</p>
                    <button onclick="window.location.href='/pricing.html'" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
                        View Plans
                    </button>
                </div>
            </div>
        </div>

        <!-- Usage Overview -->
        <div id="usageOverview" class="hidden bg-white shadow rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Usage Overview</h2>
                <p class="text-sm text-gray-600">Current billing period usage</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="usage-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600">Reviews</span>
                            <i class="fas fa-star text-yellow-500"></i>
                        </div>
                        <div class="flex items-baseline">
                            <span id="reviewsUsage" class="text-2xl font-semibold text-gray-900">0</span>
                            <span id="reviewsLimit" class="text-sm text-gray-500 ml-1">/ 100</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div id="reviewsProgress" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="usage-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600">Team Members</span>
                            <i class="fas fa-users text-green-500"></i>
                        </div>
                        <div class="flex items-baseline">
                            <span id="teamUsage" class="text-2xl font-semibold text-gray-900">1</span>
                            <span id="teamLimit" class="text-sm text-gray-500 ml-1">/ 2</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div id="teamProgress" class="bg-green-600 h-2 rounded-full" style="width: 50%"></div>
                        </div>
                    </div>

                    <div class="usage-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600">API Calls</span>
                            <i class="fas fa-code text-purple-500"></i>
                        </div>
                        <div class="flex items-baseline">
                            <span id="apiUsage" class="text-2xl font-semibold text-gray-900">0</span>
                            <span id="apiLimit" class="text-sm text-gray-500 ml-1">/ 1,000</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div id="apiProgress" class="bg-purple-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="usage-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600">Automation Rules</span>
                            <i class="fas fa-robot text-red-500"></i>
                        </div>
                        <div class="flex items-baseline">
                            <span id="automationUsage" class="text-2xl font-semibold text-gray-900">0</span>
                            <span id="automationLimit" class="text-sm text-gray-500 ml-1">/ 3</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div id="automationProgress" class="bg-red-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Methods -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-medium text-gray-900">Payment Methods</h2>
                    <button onclick="showAddPaymentModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>Add Payment Method
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="paymentMethods" class="space-y-4">
                    <!-- Payment methods will be loaded here -->
                </div>
                <div id="noPaymentMethods" class="hidden text-center py-8">
                    <i class="fas fa-credit-card text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Payment Methods</h3>
                    <p class="text-gray-600">Add a payment method to manage your subscription</p>
                </div>
            </div>
        </div>

        <!-- Billing History -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Billing History</h2>
            </div>
            <div class="p-6">
                <div id="invoicesList" class="space-y-4">
                    <!-- Invoices will be loaded here -->
                </div>
                <div id="noInvoices" class="hidden text-center py-8">
                    <i class="fas fa-file-invoice text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Invoices</h3>
                    <p class="text-gray-600">Your billing history will appear here</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrade Plan Modal -->
    <div id="upgradeModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Upgrade Your Plan</h3>
                    <button onclick="hideUpgradeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="planOptions" class="space-y-4">
                    <!-- Plan options will be loaded here -->
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="hideUpgradeModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                    <button id="confirmUpgrade" onclick="confirmUpgrade()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Upgrade Plan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Method Modal -->
    <div id="addPaymentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Add Payment Method</h3>
                    <button onclick="hideAddPaymentModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="payment-form">
                    <div id="card-element" class="p-3 border border-gray-300 rounded-md">
                        <!-- Stripe Elements will create form elements here -->
                    </div>
                    <div id="card-errors" role="alert" class="text-red-600 text-sm mt-2"></div>
                    
                    <div class="mt-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="setAsDefault" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-600">Set as default payment method</span>
                        </label>
                    </div>
                </form>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="hideAddPaymentModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                    <button id="submit-payment" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Add Payment Method
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Subscription Modal -->
    <div id="cancelModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Cancel Subscription</h3>
                    <button onclick="hideCancelModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-gray-600 mb-4">We're sorry to see you go! Your subscription will remain active until the end of your current billing period.</p>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
                        <div class="flex">
                            <i class="fas fa-exclamation-triangle text-yellow-400 mt-0.5 mr-3"></i>
                            <div>
                                <h4 class="text-sm font-medium text-yellow-800">What happens when you cancel:</h4>
                                <ul class="text-sm text-yellow-700 mt-1 list-disc list-inside">
                                    <li>You'll keep access until your current period ends</li>
                                    <li>No future charges will be made</li>
                                    <li>Your data will be preserved for 30 days</li>
                                    <li>You can reactivate anytime before deletion</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="confirmCancel" class="rounded border-gray-300 text-red-600 shadow-sm focus:border-red-300 focus:ring focus:ring-red-200 focus:ring-opacity-50">
                        <label for="confirmCancel" class="ml-2 text-sm text-gray-600">I understand and want to cancel my subscription</label>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button onclick="hideCancelModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Keep Subscription
                    </button>
                    <button id="confirmCancelBtn" onclick="confirmCancel()" disabled class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        Cancel Subscription
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-4"></div>
            <span class="text-gray-700">Processing...</span>
        </div>
    </div>

    <script>
        // Global variables
        let stripe;
        let elements;
        let card;
        let currentUser = null;
        let currentSubscription = null;
        let selectedPlan = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeStripe();
            checkAuthentication();
            setupEventListeners();
        });

        function initializeStripe() {
            // Initialize Stripe (you'll need to set your publishable key)
            stripe = Stripe('pk_test_your_publishable_key_here'); // Replace with actual key
            elements = stripe.elements();
        }

        function checkAuthentication() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            // Verify token and get user info
            fetch('/api/auth/verify', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    currentUser = data.user;
                    document.getElementById('userName').textContent = data.user.email;
                    document.getElementById('userInfo').classList.remove('hidden');
                    loadBillingData();
                } else {
                    localStorage.removeItem('token');
                    window.location.href = '/';
                }
            })
            .catch(error => {
                console.error('Authentication error:', error);
                window.location.href = '/';
            });
        }

        function loadBillingData() {
            Promise.all([
                loadSubscriptionStatus(),
                loadPaymentMethods(),
                loadInvoices()
            ]).then(() => {
                hideLoading();
            });
        }

        function loadSubscriptionStatus() {
            return fetch('/api/payments/subscription/status', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.has_subscription) {
                    currentSubscription = data;
                    showSubscriptionInfo(data);
                    loadUsageData();
                } else {
                    document.getElementById('noSubscription').classList.remove('hidden');
                }
            });
        }

        function showSubscriptionInfo(subscription) {
            document.getElementById('subscriptionStatus').classList.remove('hidden');
            document.getElementById('planName').textContent = subscription.plan_name;
            document.getElementById('planStatus').textContent = `Status: ${subscription.status}`;
            document.getElementById('billingCycle').textContent = `Billed ${subscription.billing_cycle}`;
            
            const nextBilling = new Date(subscription.current_period_end);
            document.getElementById('nextBilling').textContent = `Next billing: ${nextBilling.toLocaleDateString()}`;

            if (subscription.trial_end) {
                const trialEnd = new Date(subscription.trial_end);
                document.getElementById('trialInfo').classList.remove('hidden');
                document.getElementById('trialEnd').textContent = `Trial ends: ${trialEnd.toLocaleDateString()}`;
            }

            if (subscription.cancel_at_period_end) {
                document.getElementById('cancelBtn').textContent = 'Reactivate';
                document.getElementById('cancelBtn').className = 'bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700';
            }
        }

        function loadUsageData() {
            document.getElementById('usageOverview').classList.remove('hidden');
            // Load usage data for different features
            // This would typically come from your API
        }

        function loadPaymentMethods() {
            return fetch('/api/payments/payment-methods', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('paymentMethods');
                const noMethods = document.getElementById('noPaymentMethods');
                
                if (data.payment_methods && data.payment_methods.length > 0) {
                    container.innerHTML = '';
                    data.payment_methods.forEach(method => {
                        const methodElement = createPaymentMethodElement(method);
                        container.appendChild(methodElement);
                    });
                    noMethods.classList.add('hidden');
                } else {
                    noMethods.classList.remove('hidden');
                }
            });
        }

        function createPaymentMethodElement(method) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg';
            
            div.innerHTML = `
                <div class="flex items-center">
                    <i class="fab fa-cc-${method.brand} text-2xl text-gray-600 mr-4"></i>
                    <div>
                        <p class="font-medium text-gray-900">•••• •••• •••• ${method.last4}</p>
                        <p class="text-sm text-gray-600">Expires ${method.exp_month}/${method.exp_year}</p>
                        ${method.is_default ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Default</span>' : ''}
                    </div>
                </div>
                <div class="flex space-x-2">
                    ${!method.is_default ? `<button onclick="setDefaultPaymentMethod('${method.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Set Default</button>` : ''}
                    <button onclick="removePaymentMethod('${method.id}')" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                </div>
            `;
            
            return div;
        }

        function loadInvoices() {
            return fetch('/api/payments/invoices', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('invoicesList');
                const noInvoices = document.getElementById('noInvoices');
                
                if (data.invoices && data.invoices.length > 0) {
                    container.innerHTML = '';
                    data.invoices.forEach(invoice => {
                        const invoiceElement = createInvoiceElement(invoice);
                        container.appendChild(invoiceElement);
                    });
                    noInvoices.classList.add('hidden');
                } else {
                    noInvoices.classList.remove('hidden');
                }
            });
        }

        function createInvoiceElement(invoice) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg';
            
            const date = new Date(invoice.created).toLocaleDateString();
            const statusColor = invoice.status === 'paid' ? 'green' : invoice.status === 'open' ? 'yellow' : 'red';
            
            div.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-file-invoice text-gray-600 mr-4"></i>
                    <div>
                        <p class="font-medium text-gray-900">Invoice #${invoice.id.slice(-8)}</p>
                        <p class="text-sm text-gray-600">${date}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="font-medium text-gray-900">$${invoice.amount_paid.toFixed(2)}</p>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                            ${invoice.status}
                        </span>
                    </div>
                    <div class="flex space-x-2">
                        <a href="${invoice.hosted_invoice_url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">View</a>
                        <a href="${invoice.invoice_pdf}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">Download</a>
                    </div>
                </div>
            `;
            
            return div;
        }

        function setupEventListeners() {
            // Cancel confirmation checkbox
            document.getElementById('confirmCancel').addEventListener('change', function() {
                document.getElementById('confirmCancelBtn').disabled = !this.checked;
            });
        }

        // Modal functions
        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
            loadPlanOptions();
        }

        function hideUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function showAddPaymentModal() {
            document.getElementById('addPaymentModal').classList.remove('hidden');
            setupStripeElements();
        }

        function hideAddPaymentModal() {
            document.getElementById('addPaymentModal').classList.add('hidden');
            if (card) {
                card.destroy();
            }
        }

        function showCancelModal() {
            document.getElementById('cancelModal').classList.remove('hidden');
        }

        function hideCancelModal() {
            document.getElementById('cancelModal').classList.add('hidden');
            document.getElementById('confirmCancel').checked = false;
            document.getElementById('confirmCancelBtn').disabled = true;
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Stripe Elements setup
        function setupStripeElements() {
            const style = {
                base: {
                    color: '#424770',
                    fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                    fontSmoothing: 'antialiased',
                    fontSize: '16px',
                    '::placeholder': {
                        color: '#aab7c4'
                    }
                },
                invalid: {
                    color: '#9e2146',
                    iconColor: '#9e2146'
                }
            };

            card = elements.create('card', {style: style});
            card.mount('#card-element');

            card.on('change', function(event) {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });

            document.getElementById('submit-payment').addEventListener('click', handleAddPaymentMethod);
        }

        // Payment method functions
        function handleAddPaymentMethod(event) {
            event.preventDefault();
            showLoading();

            stripe.createPaymentMethod({
                type: 'card',
                card: card,
            }).then(function(result) {
                if (result.error) {
                    document.getElementById('card-errors').textContent = result.error.message;
                    hideLoading();
                } else {
                    addPaymentMethodToCustomer(result.paymentMethod.id);
                }
            });
        }

        function addPaymentMethodToCustomer(paymentMethodId) {
            const setAsDefault = document.getElementById('setAsDefault').checked;

            fetch('/api/payments/add-payment-method', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    payment_method_id: paymentMethodId,
                    set_as_default: setAsDefault
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.error) {
                    document.getElementById('card-errors').textContent = data.error;
                } else {
                    hideAddPaymentModal();
                    loadPaymentMethods();
                    showNotification('Payment method added successfully', 'success');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                document.getElementById('card-errors').textContent = 'An error occurred. Please try again.';
            });
        }

        function removePaymentMethod(paymentMethodId) {
            if (confirm('Are you sure you want to remove this payment method?')) {
                showLoading();
                
                fetch('/api/payments/remove-payment-method', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        payment_method_id: paymentMethodId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.error) {
                        showNotification(data.error, 'error');
                    } else {
                        loadPaymentMethods();
                        showNotification('Payment method removed successfully', 'success');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error:', error);
                    showNotification('An error occurred. Please try again.', 'error');
                });
            }
        }

        // Billing portal
        function openBillingPortal() {
            showLoading();
            
            fetch('/api/payments/create-portal-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    return_url: window.location.href
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    showNotification('Unable to open billing portal', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showNotification('An error occurred. Please try again.', 'error');
            });
        }

        // Subscription management
        function confirmCancel() {
            showLoading();
            
            fetch('/api/payments/cancel-subscription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    immediate: false
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                hideCancelModal();
                if (data.error) {
                    showNotification(data.error, 'error');
                } else {
                    showNotification('Subscription canceled successfully', 'success');
                    loadSubscriptionStatus();
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showNotification('An error occurred. Please try again.', 'error');
            });
        }

        // Utility functions
        function showNotification(message, type) {
            // Create and show notification
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
    </script>
</body>
</html>

